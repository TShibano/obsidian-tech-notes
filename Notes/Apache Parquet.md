---
title: "Apache Parquet"
date: 2026-02-07
tags:
  - Cloud
  - DB
related:
  - "[[データレイク]]"
  - "[[データ基盤]]"
  - "[[オブジェクトストレージ]]"
  - "[[Apache Avro]]"
  - "[[Apache Iceberg]]"
---

## 概要

Apache Parquet は、Apache Software Foundation が開発したオープンソースの**列指向（カラムナ型）データファイル形式**である。データを列単位でまとめて保存することで、特定の列のみを対象としたクエリ処理を高速に実行でき、効率的なデータ圧縮も実現する。ビッグデータ分析や[[データレイク]]のストレージ形式として広く採用されている。

## 詳細

### Parquet のファイル構造

Parquet ファイルは以下の階層構造で構成される:

```
Parquet File
├── Row Group 1
│   ├── Column Chunk (列A)
│   │   ├── Page 1 (データ + ヘッダー)
│   │   └── Page 2
│   ├── Column Chunk (列B)
│   │   └── Page 1
│   └── ...
├── Row Group 2
│   └── ...
└── Footer (メタデータ + スキーマ)
```

| 構成要素 | 説明 |
|---------|------|
| **Row Group** | データセットの水平分割単位。並列処理と効率的なメモリ管理を実現 |
| **Column Chunk** | Row Group 内の1つの列のデータ。列単位での読み取りが可能 |
| **Page** | Column Chunk 内のデータブロック。圧縮とエンコーディングの最小単位 |
| **Footer** | ファイル末尾に配置されるメタデータ。スキーマ定義、各列の統計情報（最小値・最大値・null 数）、Row Group の位置情報を含む |

### 行指向 vs 列指向

| 観点 | 行指向（CSV / JSON） | 列指向（Parquet） |
|------|---------------------|-------------------|
| データ配置 | 1行のデータを連続して格納 | 同一列のデータを連続して格納 |
| 全列参照 | 高速（1行をまとめて読める） | やや低速（列ごとに読む必要あり） |
| 特定列参照 | 低速（不要な列も読む必要あり） | 高速（必要な列のみ読める） |
| 圧縮効率 | 低い（異なるデータ型が混在） | 高い（同一データ型が連続） |
| 適するワークロード | OLTP、行単位の挿入・更新 | OLAP、集計・分析クエリ |

### メリット

- **クエリ性能の向上**: 必要な列のみを読み取るため、分析クエリが高速。行全体をスキャンする CSV/JSON に比べて大幅にパフォーマンスが改善
- **優れた圧縮率**: 同一データ型が連続して格納されるため、データ型に最適化されたエンコーディングと圧縮が可能。CSV 比でストレージを3分の1以下に削減できるケースもある
- **スキーマの組み込み**: ファイル自体にスキーマ情報を持つため、データの型安全性と互換性が保証される
- **ネストされたデータ構造**: 配列やマップなどの複雑なデータ構造を効率的に管理できる（Dremel のレペティション・デフィニションレベルに基づく）
- **広いエコシステム**: Spark、Hive、Presto/Trino、Athena、BigQuery など主要な分析エンジンが対応
- **コスト削減**: S3 + Athena のようなクエリ課金型サービスでは、スキャンデータ量の削減が直接的なコスト削減につながる

### 効率化技術

#### 1. エンコーディング

データの特性に応じた効率的なエンコーディング方式を適用する:

| エンコーディング | 説明 | 適するデータ |
|----------------|------|-------------|
| **辞書エンコーディング（Dictionary）** | 出現する値を辞書に登録し、データ本体をインデックスで置き換える | カーディナリティの低いカラム（カテゴリ値、ステータス等） |
| **ランレングスエンコーディング（RLE）** | 連続する同一値を「値 × 回数」で表現 | ソート済みデータ、繰り返しの多い値 |
| **ビットパッキング** | 値の範囲に応じて必要最小限のビット数で格納 | 整数値（小さな範囲の値） |
| **デルタエンコーディング** | 前の値との差分のみを格納 | タイムスタンプ、連番 |

#### 2. 圧縮

ページ単位でデータブロックを圧縮し、ストレージ効率を向上:

| 圧縮方式 | 特徴 |
|---------|------|
| **Snappy** | 高速な圧縮・解凍。圧縮率はやや低いが、分析ワークロードに最適 |
| **GZIP** | 高い圧縮率。圧縮・解凍は低速。ストレージコスト削減重視の場合に有効 |
| **ZSTD（Zstandard）** | Snappy 並みの速度で GZIP 並みの圧縮率。近年のデファクト |
| **LZ4** | 最も高速な圧縮・解凍。リアルタイム処理向け |

#### 3. 列プルーニング（Column Pruning）

クエリが参照する列のみをディスクから読み取り、不要な列を完全にスキップする技術。列指向フォーマットの最大の利点であり、ディスク I/O を劇的に削減する。

#### 4. 述語プッシュダウン（Predicate Pushdown）

Footer に格納された統計情報（各列の最小値・最大値）を活用し、WHERE 句の条件に合致しない Row Group や Page を読み取らずにスキップする技術。例えば `WHERE price > 1000` というクエリに対し、ある Row Group の price 列の最大値が 500 であれば、その Row Group 全体を読み飛ばせる。

#### 5. Row Group スキッピング

Footer のメタデータに基づき、条件に合致しないRow Group 全体をスキップ。述語プッシュダウンと組み合わせることで、大規模データセットでも高速なクエリが実現する。

### 最新動向（2025〜2026年）

- **parquet-java 1.17.0**（2026年1月リリース）: Java 11 を最小ランタイムに引き上げ（Java 8 のサポート終了）
- **parquet-format 2.12.0**（2025年8月リリース）: V2 フォーマットの安定化が進行中
- **FSST エンコーディング**: 文字列・バイト配列の圧縮効率を向上させる Finite State Symbol Table 圧縮の設計が進行中
- **Format V3**: 2026年に Parquet フォーマット v3 の策定が始まる見込み
- [[Apache Iceberg]] や Delta Lake のストレージフォーマットとしてデファクトの位置を確立

## ポイント

- 列指向フォーマットにより、分析クエリの性能向上と高い圧縮率を実現
- エンコーディング（辞書、RLE、デルタ等）と圧縮（Snappy、ZSTD、GZIP 等）を列ごとに最適化可能
- 列プルーニングと述語プッシュダウンにより不要なデータの読み取りをスキップし、I/O を大幅に削減
- [[データレイク]]や[[オブジェクトストレージ]]上の分析データのデファクトスタンダード形式
- [[Apache Iceberg]]、Delta Lake 等のオープンテーブルフォーマットのデータファイル形式として広く採用

## 関連項目

- [[データレイク]]
- [[データ基盤]]
- [[オブジェクトストレージ]]
- [[Apache Avro]]
- [[Apache Iceberg]]

## 参考

- [Apache Parquet 公式サイト](https://parquet.apache.org/)
- [IBM - What is Apache Parquet?](https://www.ibm.com/think/topics/parquet)
- [Databricks - What is Parquet?](https://www.databricks.com/glossary/what-is-parquet)
- [サーバーワークス - Parquet とは何なのか。その真価は不要なデータを読み飛ばせることにあり](https://blog.serverworks.co.jp/2025/06/11/085838)
- [クラスメソッド - Apache Parquet 入門](https://dev.classmethod.jp/articles/apache-parquet-python/)
- [Apache DataFusion Blog - Parquet Pruning: Read Only What Matters](https://datafusion.apache.org/blog/2025/03/20/parquet-pruning/)
